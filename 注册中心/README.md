
* [注册中⼼](#注册中⼼)



---

## 注册中⼼

    有了服务的接⼝描述，下⼀步要解决的问题就是服务的发布和订阅，就是说你提供了⼀个服务，如何让外部想调⽤你的服务的⼈知道。这个时候就需要⼀个类似
    注册中⼼的⻆⾊，服务提供者将⾃⼰提供的服务以及地址登记到注册中⼼，服务消费者则从注册中⼼查询所需要调⽤的服务的地址，然后发起请求。
    
    注册中⼼可以说是实现服务化的关键，因为服务化之后，服务提供者和服务消费者不在同⼀个进程中运⾏，实现了解耦，这就需要⼀个纽带去连接服务提供者和
    服务消费者，⽽注册中⼼就正好承担了这⼀⻆⾊。此外，服务提供者可以任意伸缩即增加节点或者减少节点，通过服务健康状态检测，注册中⼼可以保持最新的
    服务节点信息，并将变化通知给订阅服务的服务消费者
    
    注册中⼼原理

    在微服务架构下，主要有三种⻆⾊：服务提供者（RPC Server）、服务消费者（RPC Client）和服务注册中⼼（Registry），三者的交互关系请看下⾯这张图
    ，我来简单解释⼀下。
    
<a href="https://ibb.co/hHFB92C"><img src="https://i.ibb.co/5vhr4s2/05-17-12.png" alt="05-17-12" border="0"></a>    
    
    
    RPC Server提供服务，在启动时，根据服务发布⽂件server.xml中的配置的信息，向Registry注册⾃身服务，并向Registry定期发送⼼跳汇报存活状态。
    
    RPC Client调⽤服务，在启动时，根据服务引⽤⽂件client.xml中配置的信息，向Registry订阅服务，把Registry返回的服务节点列表缓存在本地内存中，并与
    RPC Sever建⽴连接。
    
    当RPC Server节点发⽣变更时，Registry会同步变更，RPC Client感知后会刷新本地内存中缓存的服务节点列表。
    
    RPC Client从本地缓存的服务节点列表中，基于负载均衡算法选择⼀台RPC Sever发起调⽤。
    
    
 ## 注册中⼼实现⽅式   

注册中⼼的实现主要涉及⼏个问题：[1. 注册中⼼需要提供哪些接⼝]()，[2. 该如何部署]()；[3. 如何存储服务信息]；[4. 如何监控服务提供者节点
的存活]；[5. 如果服务提供者节点有变化如何通知服务消费者]，[6. 以及如何控制注册中⼼的访问权限]

### 1.  注册中⼼API接口

    1. 服务注册接⼝：服务提供者通过调⽤服务注册接⼝来完成服务注册。
    2. 服务反注册接⼝：服务提供者通过调⽤服务反注册接⼝来完成服务注销。
    3. ⼼跳汇报接⼝：服务提供者通过调⽤⼼跳汇报接⼝完成节点存活状态上报。
    4. 服务订阅接⼝：服务消费者通过调⽤服务订阅接⼝完成服务订阅，获取可⽤的服务提供者节点列表。
    5. 服务变更查询接⼝：服务消费者通过调⽤服务变更查询接⼝，获取最新的可⽤服务节点列表。
    6. 服务查询接⼝：查询注册中⼼当前注册了哪些服务信息。
    7. 服务修改接⼝：修改注册中⼼中某⼀服务的信息。

### 2. 如何部署:
    
    集群部署

    注册中⼼⼀般都是采⽤集群部署来保证⾼可⽤性，并通过分布式⼀致性协议来确保集群中不同节点之间的数据保持⼀致.
    
### 3. 如何存储服务信息    

     ⽬录存储: 注册中⼼存储服务信息⼀般采⽤层次化的⽬录结构
     
     
### 4. 如何监控服务提供者节点的存活     

    服务健康状态检测
    
    注册中⼼除了要⽀持最基本的服务注册和服务订阅功能以外，还必须具备对服务提供者节点的健康状态检测功能，这样才能保证注册中⼼⾥保存的服务节点都是
    可⽤的
    
    
###  5. 如果服务提供者节点有变化如何通知服务消费者

    服务状态变更通知
    
    ⼀旦注册中⼼探测到有服务提供者节点新加⼊或者被剔除，就必须⽴刻通知所有订阅该服务的服务消费者，刷新本地缓存的服务节点信息，确保服务调⽤不会请
    求不可⽤的服务提供者节点。

### 6. 以及如何控制注册中⼼的访问权限 
    
    ⽩名单机制
    
    在实际的微服务测试和部署时，通常包含多套环境，⽐如⽣产环境⼀套、测试环境⼀套。开发在进⾏业务⾃测、测试在进⾏回归测试时，⼀般都是⽤测试环境，
    部署的RPC Server节点注册到测试的注册中⼼集群。但经常会出现开发或者测试在部署时，错误的把测试环境下的服务节点注册到了线上注册中⼼集群，这样
    的话线上流量就会调⽤到测试环境下的RPC Server节点，可能会造成意想不到的后果。为了防⽌这种情况发⽣，注册中⼼需要提供⼀个保护机制，你可以把注
    册中⼼想象成⼀个带有⻔禁的房间，只有拥有⻔禁卡的RPC Server才能进⼊。在实际应⽤中，注册中⼼可以提供⼀个⽩名单机制，只有添加到注册中⼼⽩名单
    内的RPC Server，才能够调⽤注册中⼼的注册接⼝，这样的话可以避免测试环境中的节点意外跑到线上环境中去
     
